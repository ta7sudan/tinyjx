{"version":3,"file":"tinyjx.umd.js","sources":["../src/index.ts"],"sourcesContent":["/* global DEBUG */\ndeclare const DEBUG: boolean;\n\nexport interface Abortable {\n\tabort: () => void;\n}\n\nexport interface SerializeOptions {\n\tdata: any;\n\tmethod: HTTPMethod;\n\tprocessData: boolean;\n\tcontentType?: string;\n\turl: string;\n\tcache: boolean;\n}\n\nexport interface SerializeResult {\n\turl: string;\n\tdata: any;\n}\n\nexport interface DeserializeOptions {\n\tdata: any;\n\tcontentType: string | null | undefined;\n\tacceptType: string;\n}\n\nexport interface ConfigOptions {\n\tpool?: number | boolean;\n\tserialize?: Serialize;\n\tdeserialize?: Deserialize;\n}\n\nexport interface NoBodyMethodOptions {\n\tcontentType?: string;\n\tbeforeSend?(xhr: CustomXMLHttpRequest, options: AjaxOptions): boolean | void;\n\tcomplete?(xhr: XMLHttpRequest, status: string): any;\n\tdataType?: string;\n\tprocessData?: boolean;\n\t// 不允许取得_active和requestURL, 所以用XMLHttpRequest而不是CustomXMLHttpRequest\n\trecoverableError?(err: Error, resData: any, xhr: XMLHttpRequest, event: UIEvent | Event): any;\n\tunrecoverableError?(err: Error, xhr: XMLHttpRequest, event: UIEvent | Event): any;\n\theaders?: Record<string, string>;\n\tmimeType?: keyof MIMEType;\n\tusername?: string;\n\tpassword?: string;\n\tsuccess?(resData: any, xhr: XMLHttpRequest, event: Event): any;\n\tevents?: XhrEventsObj;\n\tuploadEvents?: XhrEventsObj;\n\tcache?: boolean;\n\tserialize?: Serialize;\n\tdeserialize?: Deserialize;\n\tresponseType?: XMLHttpRequestResponseType;\n\ttimeout?: number;\n\tontimeout?(event: ProgressEvent): any;\n\twithCredentials?: boolean;\n}\n\nexport interface BodyMethodOptions extends NoBodyMethodOptions {\n\tdata?: any;\n}\n\nexport interface AjaxOptions extends BodyMethodOptions {\n\turl?: string;\n\tmethod?: HTTPMethod;\n}\n\ninterface CustomXMLHttpRequest extends XMLHttpRequest {\n\t_id: number;\n\t_active: boolean;\n\trequestURL: string;\n}\n\ntype PredefinedContentType = 'json' | 'form' | 'html' | 'xml' | 'text';\n\nexport type MIMEType = Record<PredefinedContentType, string>;\n\nexport interface JsonpOptions {\n\turl: string;\n\tcache?: boolean;\n\tcrossorigin?: string;\n\tcallbackName?: string;\n\t// success不关心返回值就没必要去约束为void\n\tsuccess?(data?: any): any;\n\t// beforeSend关心返回值是否是布尔值, 那就还是约束下\n\tbeforeSend?(url: string, options: JsonpOptions): boolean | void;\n\tcomplete?(status: string): any;\n\terror?(err: Error, event: string | UIEvent | Event): any;\n}\n\ntype XhrEvents =\n\t| 'onloadstart'\n\t| 'onprogress'\n\t| 'onabort'\n\t| 'onerror'\n\t| 'onload'\n\t| 'ontimeout'\n\t| 'onloadend'\n\t| 'onreadystatechange';\n\ntype ResponseCategory = 'responseXML' | 'response' | 'responseText';\n\ntype Callable = (...args: Array<any>) => any;\n\nexport type HTTPMethod =\n\t| 'GET'\n\t| 'POST'\n\t| 'HEAD'\n\t| 'PUT'\n\t| 'PATCH'\n\t| 'DELETE'\n\t| 'OPTIONS'\n\t| 'get'\n\t| 'post'\n\t| 'head'\n\t| 'put'\n\t| 'patch'\n\t| 'delete'\n\t| 'options';\n\nexport type Serialize = (options: SerializeOptions) => SerializeResult;\n\nexport type Deserialize = (options: DeserializeOptions) => any;\n\nexport type XhrEventsObj = Record<XhrEvents, Callable>;\n\nconst isFn = (fn: any): fn is Callable => typeof fn === 'function';\n\nconst isJSON = (cType: string): boolean => /application\\/json/i.test(cType);\n\nconst isForm = (cType: string): boolean => /application\\/x-www-form-urlencoded/i.test(cType);\n\nconst isNoEmptyStr = (v: any): v is string => v && typeof v === 'string';\n\nconst isStrOrStrListRecord = (o: any): o is Record<string, string | Array<string>> =>\n\tObject.prototype.toString.call(o) === '[object Object]';\n\nconst lc = window.location;\n\nconst xhrPool: Array<CustomXMLHttpRequest> = [],\n\t// tslint:disable-next-line\n\tArrayBufferView = Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array())).constructor,\n\t// 为什么这里不用字符串枚举?\n\t// 因为枚举的反查带来不必要的开销, 而const枚举\n\t// 又会在编译时内联, 不能使用key索引查找值,\n\t// 另一方面又希望有一些类型检查, 所以折中这样\n\tMIME: MIMEType = {\n\t\tjson: 'application/json',\n\t\tform: 'application/x-www-form-urlencoded',\n\t\thtml: 'text/html',\n\t\txml: 'application/xml',\n\t\ttext: 'text/plain'\n\t},\n\tevents: Array<XhrEvents> = [\n\t\t'onloadstart',\n\t\t'onprogress',\n\t\t'onabort',\n\t\t'onerror',\n\t\t'onload',\n\t\t'ontimeout',\n\t\t'onloadend',\n\t\t'onreadystatechange'\n\t];\n\nlet jsonpId = Date.now(),\n\tcacheRand = Date.now() + 5,\n\tglobalSerialize: Callable | null = null,\n\tglobalDeserialize: Callable | null = null;\n\nif (DEBUG) {\n\tvar xhrId = 0;\n}\n\nfunction createXhr(): CustomXMLHttpRequest {\n\t// 不用class继承, 省得编译出来多一个函数\n\tconst xhr: CustomXMLHttpRequest = new XMLHttpRequest() as CustomXMLHttpRequest;\n\tObject.defineProperty(xhr, '_active', {\n\t\tvalue: false,\n\t\twritable: true,\n\t\tenumerable: false\n\t});\n\tObject.defineProperty(xhr, 'requestURL', {\n\t\tvalue: '',\n\t\twritable: true,\n\t\tenumerable: false\n\t});\n\tif (DEBUG) {\n\t\tObject.defineProperty(xhr, '_id', {\n\t\t\tvalue: ++xhrId,\n\t\t\twritable: true,\n\t\t\tenumerable: false\n\t\t});\n\t}\n\treturn xhr;\n}\n\nfunction resetXhr(xhr: CustomXMLHttpRequest): void {\n\t// responseType, withCredentials以及header相关的会在open后重置\n\txhr._active = false;\n\t// 可能是同步请求那就不能设置timeout\n\ttry {\n\t\txhr.timeout = 0;\n\t\txhr.requestURL = '';\n\t\t// tslint:disable-next-line\n\t} catch (e) {}\n\tevents.forEach((v: XhrEvents) => (xhr[v] = null));\n\t// 这里不建议给XMLHttpRequestUpload patch一个索引类型, 可能影响到其他地方\n\txhr.upload && events.forEach((v: XhrEvents) => ((xhr.upload as any)[v] = null));\n}\n\nfunction xhrFactory(): CustomXMLHttpRequest {\n\tfor (let i = 0, len = xhrPool.length; i < len; ++i) {\n\t\tif (!xhrPool[i]._active) {\n\t\t\treturn xhrPool[i];\n\t\t}\n\t}\n\treturn createXhr();\n}\n\nfunction querystring(obj: Record<string, string | Array<string>>): string {\n\tif (isStrOrStrListRecord(obj)) {\n\t\treturn Object.keys(obj)\n\t\t\t.map((k: string) => {\n\t\t\t\tconst value = obj[k];\n\t\t\t\treturn Array.isArray(value)\n\t\t\t\t\t? value.map((v: string) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&')\n\t\t\t\t\t: `${encodeURIComponent(k)}=${encodeURIComponent(value)}`;\n\t\t\t})\n\t\t\t.join('&');\n\t} else {\n\t\treturn JSON.stringify(obj);\n\t}\n}\n\nconst defaultSerialize: Serialize = ({\n\tdata,\n\tmethod,\n\tprocessData,\n\tcontentType = MIME.json,\n\turl,\n\tcache\n}: SerializeOptions): SerializeResult => {\n\tif (!cache) {\n\t\t// 字符串不可变, 所以这里懒得起名了, 赋值url其实不影响外部\n\t\t// tslint:disable-next-line\n\t\turl += ~url.indexOf('?') ? `&_=${++cacheRand}` : `?_=${++cacheRand}`;\n\t}\n\tif (method === 'GET' || method === 'HEAD') {\n\t\tif (processData) {\n\t\t\t// tslint:disable-next-line\n\t\t\turl += ~url.indexOf('?') ? `&${querystring(data)}` : `?${querystring(data)}`;\n\t\t}\n\t\treturn {\n\t\t\turl,\n\t\t\tdata\n\t\t};\n\t}\n\tif (\n\t\tdata instanceof Document ||\n\t\t// URLSearchParams和ReadableStream暂时不考虑支持了, 浏览器版本要求比较高\n\t\t// data instanceof URLSearchParams ||\n\t\t// data instanceof ReadableStream ||\n\t\tdata instanceof Blob ||\n\t\tdata instanceof FormData ||\n\t\tdata instanceof ArrayBuffer ||\n\t\tdata instanceof ArrayBufferView ||\n\t\ttypeof data === 'string'\n\t) {\n\t\treturn {\n\t\t\turl,\n\t\t\tdata\n\t\t};\n\t}\n\tlet resultData = null;\n\tif (isJSON(contentType)) {\n\t\tresultData = JSON.stringify(data);\n\t} else if (isForm(contentType)) {\n\t\tresultData = querystring(data);\n\t} else {\n\t\tthrow new TypeError(\n\t\t\t'Unknown data type, you can provide a custom serialize function in options to override the default.'\n\t\t);\n\t}\n\treturn {\n\t\turl,\n\t\tdata: resultData\n\t};\n};\n\nconst defaultDeserialize: Deserialize = ({\n\tdata,\n\tcontentType,\n\tacceptType\n}: DeserializeOptions): any => {\n\tlet rst = null;\n\tif (\n\t\tisNoEmptyStr(data) &&\n\t\t((isNoEmptyStr(contentType) && isJSON(contentType)) || isJSON(acceptType))\n\t) {\n\t\ttry {\n\t\t\trst = JSON.parse(data);\n\t\t} catch (e) {\n\t\t\tconsole.error('Invalid json string');\n\t\t\trst = data;\n\t\t}\n\t} else {\n\t\trst = data;\n\t}\n\treturn rst;\n};\n\nfunction setHeaders(xhr: CustomXMLHttpRequest, headers: Record<string, string>): void {\n\tObject.keys(headers).forEach((k: string) => xhr.setRequestHeader(k, headers[k]));\n}\n\nfunction setEvents(target: CustomXMLHttpRequest | XMLHttpRequestUpload, evts?: XhrEventsObj): void {\n\tif (isStrOrStrListRecord(evts) && target) {\n\t\t// 不用addEventListener是它不方便reset\n\t\tObject.keys(evts)\n\t\t\t.filter((k: string): k is XhrEvents => events.includes(k as XhrEvents))\n\t\t\t.forEach((k: XhrEvents) => ((target as XhrEventsObj)[k] = evts[k]));\n\t}\n}\n\nfunction jsonp(opts: JsonpOptions): void {\n\tlet {\n\t\turl,\n\t\t/* tslint:disable */\n\t\tcache = false,\n\t\tcrossorigin,\n\t\tcallbackName,\n\t\tsuccess,\n\t\tbeforeSend,\n\t\tcomplete,\n\t\terror\n\t\t/* tslint:enable */\n\t} = opts;\n\n\tconst hasOriginalCb = callbackName && isFn((window as any)[callbackName]);\n\tif (isNoEmptyStr(callbackName) && !hasOriginalCb) {\n\t\tthrow new Error(`${callbackName} is not a function.`);\n\t}\n\n\tconst hasSuccessCb = isFn(success),\n\t\thasErrorCb = isFn(error),\n\t\thasCompleteCb = isFn(complete),\n\t\t// hasOriginalCb为true的话, callbackName肯定不为空, 前面已经判断过了, 这里把空值去除\n\t\toriginalCb = hasOriginalCb ? (window as any)[callbackName!] : undefined;\n\n\tif (!hasSuccessCb && !hasCompleteCb && !hasOriginalCb) {\n\t\tthrow new Error('Must set a success callback or complete callback.');\n\t}\n\tif (!isNoEmptyStr(url)) {\n\t\tthrow new TypeError(`url expected a non empty string, but received ${JSON.stringify(url)}.`);\n\t}\n\n\tconst hasCustomCbName = isNoEmptyStr(callbackName),\n\t\t// hasCustomCbName为true的话, callbackName肯定为非空字符串, 这里去掉空值\n\t\tcbName = hasCustomCbName ? callbackName! : `jsonp${++jsonpId}`,\n\t\tscript = document.createElement('script');\n\n\tif (url.split('?').length < 3) {\n\t\t// 没有占位符的话默认callback\n\t\tconst qs = `callback=${encodeURIComponent(cbName)}`;\n\t\turl = ~url.indexOf('?') ? `${url}&${qs}` : `${url}?${qs}`;\n\t} else {\n\t\turl = url.replace(/\\?(.+)=\\?/, `?$1=${encodeURIComponent(cbName)}`);\n\t}\n\t!cache && (url += `&_=${++cacheRand}`);\n\n\tconst w = window as any;\n\tif (!w[cbName] || !w[cbName].hasHook) {\n\t\tw[cbName] = function (...args: Array<any>): void {\n\t\t\t// 放前面, 防止后面的callback抛异常导致删不掉\n\t\t\tif (!hasCustomCbName) {\n\t\t\t\tdelete w[cbName];\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tif (hasOriginalCb) {\n\t\t\t\t\toriginalCb(...args);\n\t\t\t\t} else if (hasSuccessCb) {\n\t\t\t\t\t// 这里hasSuccessCb已经是类型保护isFn的结果了, 但是需要直接调用isFn\n\t\t\t\t\t// 才能获得类型保护, 为了减少函数调用, 就暂存了类型保护的结果为hasSuccessCb\n\t\t\t\t\t// 所以这里success也应当是不为空的, 去掉空值, 但是是用!去除还是用as\n\t\t\t\t\t// 应该是都可以, 但是这里来讲应该是!好一点, 因为这里success用as那就是Callble,\n\t\t\t\t\t// 用!那就是JsonpOptions中定义的类型, Callble更关心success是否可以作为函数调用,\n\t\t\t\t\t// 而JsonpOptions中的定义更关心具体参数的类型和个数, 这里我们更关心参数类型,\n\t\t\t\t\t// 所以用!去除空值\n\t\t\t\t\tsuccess!(...args);\n\t\t\t\t}\n\t\t\t\thasCompleteCb && complete!('success');\n\t\t\t\t// 同样, hasOriginalCb为true则callbackName不可能空, 去除空值\n\t\t\t\thasOriginalCb && (w[callbackName!] = originalCb);\n\t\t\t} catch (e) {\n\t\t\t\t// 个人觉得应该crash掉让用户修复异常而不是继续执行complete\n\t\t\t\t// 所以这里只是为了还原window上原有的函数而不是为了吞掉异常\n\t\t\t\thasOriginalCb && (w[callbackName!] = originalCb);\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t};\n\t\tw[cbName].hasHook = true;\n\t}\n\n\tscript.onerror = function (e: string | Event): void {\n\t\tdocument.body.removeChild(script);\n\t\tif (!hasCustomCbName) {\n\t\t\tdelete w[cbName];\n\t\t}\n\t\t// 都没有的话就继续抛出异常, 方便异常监控系统捕获\n\t\tif (!hasErrorCb && !hasCompleteCb) {\n\t\t\tthrow new Error(`Load script ${url} failed.`);\n\t\t}\n\t\thasErrorCb && error!(new Error(`Load script ${url} failed.`), e);\n\t\thasCompleteCb && complete!('error');\n\t};\n\n\tscript.onload = (): ReturnType<typeof setTimeout> =>\n\t\tsetTimeout(() => document.body.removeChild(script), 3000);\n\n\tcrossorigin && (script.crossOrigin = crossorigin);\n\tscript.src = url;\n\n\tif (isFn(beforeSend)) {\n\t\tsetTimeout(() => {\n\t\t\t// 允许拦截掉不发送请求\n\t\t\tconst rst = beforeSend!(url, opts);\n\t\t\trst !== false && document.body.appendChild(script);\n\t\t});\n\t} else {\n\t\tdocument.body.appendChild(script);\n\t}\n}\n\nfunction getResponse(xhr: CustomXMLHttpRequest, key: ResponseCategory): any {\n\t// 在有responseType的情况下, 访问responseXML, responseText等都有可能抛出异常\n\ttry {\n\t\treturn xhr[key];\n\t} catch (e) {\n\t\treturn null;\n\t}\n}\n\nfunction ajax(opts: AjaxOptions): Abortable {\n\tlet {\n\t\turl = lc.href,\n\t\tmethod = 'GET' as HTTPMethod,\n\t\tcontentType: reqCtype,\n\t\tdataType: acceptType = 'json',\n\t\t/* tslint:disable */\n\t\tprocessData = true,\n\t\tdata: reqRawData,\n\t\tbeforeSend,\n\t\tcomplete,\n\t\trecoverableError,\n\t\tunrecoverableError,\n\t\theaders,\n\t\tmimeType,\n\t\tresponseType = '' as XMLHttpRequestResponseType,\n\t\tusername,\n\t\tpassword,\n\t\tsuccess,\n\t\ttimeout = 0,\n\t\tontimeout,\n\t\tevents,\n\t\tuploadEvents,\n\t\twithCredentials = false,\n\t\tcache = true,\n\t\tserialize,\n\t\tdeserialize\n\t\t/* tslint:enable */\n\t} = opts;\n\n\tmethod = method.toUpperCase().trim() as HTTPMethod;\n\t// IE是什么...\n\t// xhr不支持CONNECT, TRACE, TRACK方法\n\tif (!['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS'].includes(method)) {\n\t\tthrow new Error(`Invalid HTTP method: ${method}`);\n\t}\n\t// 允许所有callback都没有\n\n\t// 准备数据\n\tif (isNoEmptyStr(reqCtype)) {\n\t\tMIME[reqCtype as PredefinedContentType] && (reqCtype = MIME[reqCtype as PredefinedContentType]);\n\t} else if (reqCtype) {\n\t\tthrow new TypeError(\n\t\t\t'contentType could be \"json\", \"form\", \"html\", \"xml\", \"text\" or other custom string.'\n\t\t);\n\t}\n\n\tconst slz = isFn(serialize)\n\t\t\t? serialize\n\t\t\t: isFn(globalSerialize)\n\t\t\t\t? globalSerialize\n\t\t\t\t: defaultSerialize,\n\t\tdslz = isFn(deserialize)\n\t\t\t? deserialize\n\t\t\t: isFn(globalDeserialize)\n\t\t\t\t? globalDeserialize\n\t\t\t\t: defaultDeserialize,\n\t\tmaybeProtocol = /^([\\w-]+:)\\/\\//.exec(url),\n\t\threfProtocol = /^(https?):\\/\\//.exec(lc.href),\n\t\tprotocol = maybeProtocol ? maybeProtocol[1] : hrefProtocol ? hrefProtocol[1] : null,\n\t\txhr = xhrFactory(),\n\t\thasCompleteCb = isFn(complete),\n\t\thasRecoverableErrorCb = isFn(recoverableError),\n\t\thasUnrecoverableErrorCb = isFn(unrecoverableError),\n\t\thasSuccessCb = isFn(success);\n\n\tlet reqData: any,\n\t\terrCalled = false,\n\t\tcompleteCalled = false;\n\t// 这里不用捕获异常去重置xhr是因为xhr还没激活\n\t({url, data: reqData} = slz({data: reqRawData, method, processData, contentType: reqCtype, url, cache}));\n\n\t// 初始化xhr\n\txhr._active = true;\n\txhr.open(method, url, true, username, password);\n\t!xhr.requestURL && (xhr.requestURL = url);\n\n\t// 设置必要的头部\n\tif (reqCtype) {\n\t\txhr.setRequestHeader('Content-Type', reqCtype);\n\t} else if (isNoEmptyStr(reqData)) {\n\t\t// 不在默认参数设json是为了让FormData之类的能够由浏览器自己设置\n\t\t// 这里只对字符串的body设置默认为json\n\t\txhr.setRequestHeader('Content-Type', MIME.json);\n\t}\n\tif (isNoEmptyStr(acceptType)) {\n\t\t(MIME as any)[acceptType] && (acceptType = MIME[acceptType as keyof MIMEType]);\n\t\txhr.setRequestHeader('Accept', acceptType);\n\t}\n\n\tif (isStrOrStrListRecord(headers)) {\n\t\tsetHeaders(xhr, headers);\n\t}\n\n\tisNoEmptyStr(mimeType) && xhr.overrideMimeType(mimeType);\n\n\t// 主要是给progress等事件用, 但存在破坏封装的风险\n\tsetEvents(xhr, events);\n\tsetEvents(xhr.upload, uploadEvents);\n\n\twithCredentials && (xhr.withCredentials = withCredentials);\n\tresponseType && (xhr.responseType = responseType);\n\ttimeout && (xhr.timeout = timeout);\n\tif (isFn(ontimeout)) {\n\t\txhr.ontimeout = function (e: ProgressEvent): void {\n\t\t\tontimeout!(e);\n\t\t\thasCompleteCb && complete!(this, 'timeout');\n\t\t};\n\t} else if (timeout && !isFn(xhr.ontimeout)) {\n\t\txhr.ontimeout = function (): void {\n\t\t\tif (hasCompleteCb) {\n\t\t\t\tcomplete!(this, 'timeout');\n\t\t\t} else {\n\t\t\t\t// 如果没监听ontimeout但是设置了timeout, window.onerror不会捕获这个错误, 所以手动抛个\n\t\t\t\tthrow new Error(`Request ${(this as CustomXMLHttpRequest).requestURL} timeout.`);\n\t\t\t}\n\t\t};\n\t}\n\n\t// loadend无论同步还是异步请求, 无论前面的事件是否抛异常, 它都会执行\n\tif (isFn(xhr.onloadend)) {\n\t\tconst originalLoadend = xhr.onloadend;\n\t\txhr.onloadend = function (e: ProgressEvent): void {\n\t\t\tresetXhr(this as CustomXMLHttpRequest);\n\t\t\toriginalLoadend.call(this, e);\n\t\t};\n\t} else {\n\t\txhr.onloadend = function (): void {\n\t\t\tresetXhr(this as CustomXMLHttpRequest);\n\t\t};\n\t}\n\t// 覆盖掉用户自定义onreadystatechange\n\txhr.onreadystatechange = function (e: Event): void {\n\t\tif (this.readyState === 4) {\n\t\t\tconst resCtype = this.getResponseHeader('Content-Type');\n\t\t\t// 这里也不用捕获异常, 因为xhr.onloadend会在之后帮我们回收xhr\n\t\t\tconst resData = dslz({\n\t\t\t\tdata:\n\t\t\t\t\tgetResponse(xhr, 'responseXML') ||\n\t\t\t\t\tgetResponse(xhr, 'response') ||\n\t\t\t\t\tgetResponse(xhr, 'responseText'),\n\t\t\t\tcontentType: resCtype,\n\t\t\t\tacceptType\n\t\t\t});\n\n\t\t\tif (\n\t\t\t\t(this.status >= 200 && this.status < 300) ||\n\t\t\t\tthis.status === 304 ||\n\t\t\t\t(this.status === 0 && protocol === 'file:')\n\t\t\t) {\n\t\t\t\t// 异常直接抛\n\t\t\t\thasSuccessCb && success!(resData, this, e);\n\t\t\t\thasCompleteCb && complete!(this, 'success');\n\t\t\t} else if (this.status !== 0) {\n\t\t\t\t// 这类错误xhr.onerror和window.onerror都不捕获所以手动抛一个\n\t\t\t\tif (!hasRecoverableErrorCb && !hasCompleteCb) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`Remote server error. Request URL: ${\n\t\t\t\t\t\t\t(this as CustomXMLHttpRequest).requestURL\n\t\t\t\t\t\t}, Status code: ${this.status}, message: ${this.statusText}, response: ${\n\t\t\t\t\t\t\tthis.responseText\n\t\t\t\t\t\t}.`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t// 理论上来讲好像没必要再注册xhr.onerror了, 因为如果有error那status必然为0\n\t\t\t\t// https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/status\n\t\t\t\t// 但是不加个心里不踏实...总感觉会不会有浏览器没按规范实现\n\t\t\t\t// 不过知名的库页都没监听onerror, 那说明应该是都按规范实现了的\n\t\t\t\t// 但是我要加!!!\n\t\t\t\tif (hasRecoverableErrorCb) {\n\t\t\t\t\terrCalled = true;\n\t\t\t\t\trecoverableError!(\n\t\t\t\t\t\tnew Error(\n\t\t\t\t\t\t\t`Remote server error. Request URL: ${\n\t\t\t\t\t\t\t\t(this as CustomXMLHttpRequest).requestURL\n\t\t\t\t\t\t\t}, Status code: ${this.status}, message: ${this.statusText}, response: ${\n\t\t\t\t\t\t\t\tthis.responseText\n\t\t\t\t\t\t\t}.`\n\t\t\t\t\t\t),\n\t\t\t\t\t\tresData,\n\t\t\t\t\t\tthis,\n\t\t\t\t\t\te\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif (hasCompleteCb) {\n\t\t\t\t\tcompleteCalled = true;\n\t\t\t\t\tcomplete!(this, 'error');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\t// 覆盖\n\txhr.onerror = function (e: ProgressEvent): void {\n\t\t// 跨域错误会在这里捕获, 但是window.onerror不捕获, 所以也手动抛一个\n\t\tif (!hasUnrecoverableErrorCb && !hasCompleteCb) {\n\t\t\tthrow new Error(\n\t\t\t\t`An error occurred, maybe crossorigin error. Request URL: ${\n\t\t\t\t\t(this as CustomXMLHttpRequest).requestURL\n\t\t\t\t}, Status code: ${this.status}.`\n\t\t\t);\n\t\t}\n\t\tif (!errCalled && hasUnrecoverableErrorCb) {\n\t\t\tunrecoverableError!(\n\t\t\t\tnew Error(\n\t\t\t\t\t`Network error or browser restricted. Request URL: ${\n\t\t\t\t\t\t(this as CustomXMLHttpRequest).requestURL\n\t\t\t\t\t}, Status code: ${this.status}`\n\t\t\t\t),\n\t\t\t\tthis,\n\t\t\t\te\n\t\t\t);\n\t\t}\n\t\tif (!completeCalled && hasCompleteCb) {\n\t\t\tcomplete!(this, 'error');\n\t\t}\n\t};\n\n\t// 哎...都异步吧\n\tif (isFn(beforeSend)) {\n\t\tsetTimeout(() => {\n\t\t\tlet rst;\n\t\t\ttry {\n\t\t\t\trst = beforeSend!(xhr, opts);\n\t\t\t} catch (e) {\n\t\t\t\t// 恶心之处就在于每个用户定义的callback都可能触发异常, 然而我还要回收xhr\n\t\t\t\tresetXhr(xhr);\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t\tif (rst !== false) {\n\t\t\t\txhr.send(reqData || null);\n\t\t\t} else {\n\t\t\t\tresetXhr(xhr);\n\t\t\t}\n\t\t});\n\t} else {\n\t\txhr.send(reqData || null);\n\t}\n\t// 不暴露xhr\n\treturn {\n\t\tabort(): void {\n\t\t\txhr.abort();\n\t\t}\n\t};\n}\n\nexport function config({pool = false, serialize, deserialize}: ConfigOptions = {}): void {\n\tif (pool) {\n\t\txhrPool.length = 0;\n\t\tlet poolSize = typeof pool === 'number' ? pool : 5;\n\t\tif (poolSize < 0) {\n\t\t\tthrow new Error('pool size must >= 0');\n\t\t}\n\t\twhile (poolSize--) {\n\t\t\txhrPool.push(createXhr());\n\t\t}\n\t}\n\tisFn(serialize) && (globalSerialize = serialize);\n\tisFn(deserialize) && (globalDeserialize = deserialize);\n}\n\nexport {ajax, jsonp};\n\nexport function get(url: string, opts: NoBodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tmethod: 'GET'\n\t});\n}\n\nexport function head(url: string, opts: NoBodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tmethod: 'HEAD'\n\t});\n}\n\nexport function post(url: string, data: any, opts: BodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tdata,\n\t\tmethod: 'POST'\n\t});\n}\n\nexport function put(url: string, data: any, opts: BodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tdata,\n\t\tmethod: 'PUT'\n\t});\n}\n\nexport function del(url: string, data: any, opts: BodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tdata,\n\t\tmethod: 'DELETE'\n\t});\n}\n\nexport function patch(url: string, data: any, opts: BodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tdata,\n\t\tmethod: 'PATCH'\n\t});\n}\n\nexport function options(url: string, data: any, opts: BodyMethodOptions): Abortable {\n\treturn ajax({\n\t\t...opts,\n\t\turl,\n\t\tdata,\n\t\tmethod: 'OPTIONS'\n\t});\n}\n"],"names":["isFn","fn","isJSON","cType","test","isForm","isNoEmptyStr","v","isStrOrStrListRecord","o","Object","prototype","toString","call","lc","window","location","xhrPool","ArrayBufferView","getPrototypeOf","Uint8Array","constructor","MIME","json","form","html","xml","text","events","jsonpId","Date","now","cacheRand","globalSerialize","globalDeserialize","createXhr","xhr","XMLHttpRequest","defineProperty","value","writable","enumerable","resetXhr","_active","timeout","requestURL","e","forEach","upload","xhrFactory","i","len","length","querystring","obj","keys","map","k","Array","isArray","encodeURIComponent","join","JSON","stringify","defaultSerialize","data","method","processData","contentType","url","cache","indexOf","Document","Blob","FormData","ArrayBuffer","resultData","TypeError","defaultDeserialize","acceptType","rst","parse","console","error","setHeaders","headers","setRequestHeader","setEvents","target","evts","filter","includes","jsonp","opts","crossorigin","callbackName","success","beforeSend","complete","hasOriginalCb","Error","hasSuccessCb","hasErrorCb","hasCompleteCb","originalCb","undefined","hasCustomCbName","cbName","script","document","createElement","split","qs","replace","w","hasHook","args","onerror","body","removeChild","onload","setTimeout","crossOrigin","src","appendChild","getResponse","key","ajax","href","reqCtype","dataType","reqRawData","recoverableError","unrecoverableError","mimeType","responseType","username","password","ontimeout","uploadEvents","withCredentials","serialize","deserialize","toUpperCase","trim","slz","dslz","maybeProtocol","exec","hrefProtocol","protocol","hasRecoverableErrorCb","hasUnrecoverableErrorCb","reqData","errCalled","completeCalled","open","overrideMimeType","onloadend","originalLoadend","onreadystatechange","readyState","resCtype","getResponseHeader","resData","status","statusText","responseText","send","abort","config","pool","poolSize","push","get","head","post","put","del","patch","options"],"mappings":"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"}